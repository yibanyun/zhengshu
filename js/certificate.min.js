function canvasDrawImage(context,imageURL,initX,initY,imageWidth,imageHeight){return new Promise(resolve=>{const image=new Image;image.src=imageURL,image.onload=function(){context.drawImage(image,initX,initY,imageWidth,imageHeight),resolve(!0)}})}function canvasDrawTextAutoLine(context,text,textBoxWidth,initX,initY,fontSize,lineHeight){let lineWidth=0,lastSubStrIndex=0;const _initX=initX+fontSize/2;let _initY=initY+fontSize;const _textBoxWidth=textBoxWidth+_initX,textFullHeight=fontSize*lineHeight,align=context.textAlign;let actualInitX=0;switch(align){case"left":actualInitX=_initX;break;case"center":actualInitX=(_initX+_textBoxWidth)/2;break;case"right":actualInitX=_textBoxWidth}for(let i=0;i<text.length;i++)lineWidth+=context.measureText(text[i]).width,lineWidth>_textBoxWidth-_initX&&(context.fillText(text.substring(lastSubStrIndex,i+1),actualInitX,_initY),_initY+=textFullHeight,lineWidth=0,lastSubStrIndex=i+1),i==text.length-1&&context.fillText(text.substring(lastSubStrIndex,i+1),actualInitX,_initY)}function addImageProcess(src){return new Promise((resolve,reject)=>{let img=new Image;img.onload=()=>resolve(img),img.onerror=()=>reject("图片加载失败"),img.src=src})}async function genCertificate(width,height,canvas,text_list,image_list,callback){if(canvas.width=width,canvas.height=height,canvas.getContext("2d")){const context=canvas.getContext("2d"),backgroundConfig=image_list.find(item=>"background"==item.name),bgcImg=await addImageProcess(backgroundConfig.imageURL),bgc_img_width=bgcImg.width,_ratio=bgc_img_width/backgroundConfig.width,dpr=window.devicePixelRatio,ratio=_ratio>dpr?_ratio:dpr,{width:width,height:height}=canvas;canvas.width=Math.round(width*ratio),canvas.height=Math.round(height*ratio),canvas.style.width=width+"px",canvas.style.height=height+"px",context.scale(ratio,ratio),await canvasDrawImage(context,backgroundConfig.imageURL,backgroundConfig.x,backgroundConfig.y,backgroundConfig.width,backgroundConfig.height),text_list.forEach(item=>{context.font=`${item.fontStyle} ${item.fontSize+"px"} ${item.fontFamily}`,context.textAlign=item.align,context.textBaseline=item.verticalAlign,context.fillStyle=item.fill,canvasDrawTextAutoLine(context,item.text,item.width,item.x,item.y,item.fontSize,item.lineHeight)});for(let index=0;index<image_list.length;index++){const element=image_list[index];"background"!==element.name&&await canvasDrawImage(context,element.imageURL,element.x,element.y,element.width,element.height)}const dataURL=canvas.toDataURL("image/jpeg",.92);callback(dataURL)}else alert("当前浏览器不支持Canvas，请更换浏览器后再试！")}var convertBase64ToBlob=function(base64){var base64Arr=base64.split(","),imgtype="",base64String="";base64Arr.length>1&&(base64String=base64Arr[1],imgtype=base64Arr[0].substring(base64Arr[0].indexOf(":")+1,base64Arr[0].indexOf(";")));for(var bytes=atob(base64String),bytesCode=new ArrayBuffer(bytes.length),byteArray=new Uint8Array(bytesCode),i=0;i<bytes.length;i++)byteArray[i]=bytes.charCodeAt(i);return new Blob([bytesCode],{type:imgtype})},compressImg=function(file,options,callback){var self=this,imgname=file.name,imgtype=imgname.substring(imgname.lastIndexOf(".")+1).toLowerCase();imgtype="jpg"==imgtype||"jpeg"==imgtype?"image/jpeg":"image/png";var reader=new FileReader;reader.readAsDataURL(file),reader.onload=function(evt){var base64=evt.target.result,img=new Image;img.src=base64,img.onload=function(){var that=this,canvas=document.createElement("canvas"),ctx=canvas.getContext("2d");if(canvas.setAttribute("width",this.width),canvas.setAttribute("height",this.height),ctx.drawImage(this,0,0,this.width,this.height),options.size){var scale=.9;!function f(scale){base64.length/1024/1024>options.size&&scale>0?(base64=canvas.toDataURL(imgtype,scale),f(scale-=.1)):callback(base64)}(.9)}else options.scale&&(base64=canvas.toDataURL(imgtype,options.scale),callback(base64))}}},rotate=function(srcBase64,orientation,callback){var img=new Image;img.src=srcBase64,img.onload=function(){var width=img.width,height=img.height,canvas=document.createElement("canvas"),ctx=canvas.getContext("2d");switch([5,6,7,8].indexOf(orientation)>-1?(canvas.width=height,canvas.height=width):(canvas.width=width,canvas.height=height),orientation){case 2:ctx.transform(-1,0,0,1,width,0);break;case 3:ctx.transform(-1,0,0,-1,width,height);break;case 4:ctx.transform(1,0,0,-1,0,height);break;case 5:ctx.transform(0,1,1,0,0,0);break;case 6:ctx.transform(0,1,-1,0,height,0);break;case 7:ctx.transform(0,-1,-1,0,height,width);break;case 8:ctx.transform(0,-1,1,0,0,width);break;default:ctx.transform(1,0,0,1,0,0)}ctx.drawImage(img,0,0),callback(canvas.toDataURL("image/jpeg"))}},saveImageToPDF=function(imageDataURL,fileName){const{jsPDF:jsPDF}=window.jspdf;var pdf=new jsPDF("p","mm","a4"),pdfWidth=.95*pdf.internal.pageSize.getWidth(),pdfHeight=.95*pdf.internal.pageSize.getHeight();pdf.addImage(imageDataURL,"JPEG",.025*pdfWidth,.025*pdfHeight,pdfWidth,pdfHeight),pdf.save(fileName+".pdf")};